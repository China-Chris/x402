# x402 å®Œæ•´æµç¨‹è¯¦è§£

## ğŸ“– ç›®å½•
1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
3. [è¯¦ç»†æ­¥éª¤è§£æ](#è¯¦ç»†æ­¥éª¤è§£æ)
4. [EIP-3009 åŸç†](#eip-3009-åŸç†)
5. [å®é™…ä»£ç æµç¨‹](#å®é™…ä»£ç æµç¨‹)
6. [é—®é¢˜ä¸è§£ç­”](#é—®é¢˜ä¸è§£ç­”)

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä¸‰ä¸ªè§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client        â”‚  ä»˜æ¬¾æ–¹ï¼ˆä½ çš„ç”¨æˆ·æˆ– AI Agentï¼‰
â”‚  (ä»˜æ¬¾æ–¹)        â”‚  - æƒ³è¦è®¿é—®ä»˜è´¹èµ„æº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - ç­¾åæ”¯ä»˜æˆæƒï¼ˆä¸å‘é€äº¤æ˜“ï¼‰
        â”‚            - æŒæœ‰ USDC ä»£å¸
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource Server â”‚  èµ„æºæä¾›æ–¹ï¼ˆä½ çš„ API æœåŠ¡å™¨ï¼‰
â”‚  (èµ„æºæœåŠ¡å™¨)    â”‚  - æä¾›ä»˜è´¹ API/èµ„æº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - æ£€æŸ¥æ”¯ä»˜å¹¶æä¾›æœåŠ¡
        â”‚            - ä¸éœ€è¦ç®¡ç†é’±åŒ…
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Facilitator    â”‚  æ”¯ä»˜å¤„ç†å™¨ï¼ˆä¸­é—´æœåŠ¡ï¼‰
â”‚  (æ”¯ä»˜å¤„ç†å™¨)    â”‚  - éªŒè¯æ”¯ä»˜æˆæƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - æäº¤äº¤æ˜“åˆ°åŒºå—é“¾
                     - æ”¯ä»˜ gas è´¹ç”¨
```

---

## å®Œæ•´æµç¨‹å›¾

```
æ—¶é—´çº¿ï¼šä»è¯·æ±‚åˆ°æ”¯ä»˜å®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­¥éª¤ 1ï¸âƒ£: å®¢æˆ·ç«¯é¦–æ¬¡è¯·æ±‚ï¼ˆæ²¡æœ‰æ”¯ä»˜ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Client                    Resource Server
  â”‚
  â”‚  GET /api/weather
  â”‚  (æ²¡æœ‰ X-PAYMENT å¤´)
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚                          â”‚
  â”‚                          â”‚ æ£€æŸ¥: æ²¡æœ‰æ”¯ä»˜å¤´
  â”‚                          â”‚
  â”‚  402 Payment Required    â”‚
  â”‚  + PaymentRequirements   â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚
  â”‚  {
  â”‚    "scheme": "exact",
  â”‚    "network": "hashkey-testnet",
  â”‚    "maxAmountRequired": "1000",  // 0.001 USDC (6 decimals)
  â”‚    "asset": "0xUSDCAddress",
  â”‚    "payTo": "0xServerAddress",
  â”‚    "resource": "http://localhost:4021/api/weather",
  â”‚    "extra": { "name": "USDC", "version": "2" }
  â”‚  }


æ­¥éª¤ 2ï¸âƒ£: å®¢æˆ·ç«¯åˆ›å»ºæ”¯ä»˜æˆæƒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Client (æœ¬åœ°æ“ä½œï¼Œä¸ä¸Šé“¾)
  â”‚
  â”‚ 1. æ£€æŸ¥ä½™é¢
  â”‚    - æŸ¥è¯¢ USDC åˆçº¦
  â”‚    - ç¡®è®¤æœ‰è¶³å¤Ÿçš„ USDC
  â”‚
  â”‚ 2. ç”Ÿæˆéšæœº nonce
  â”‚    - nonce = crypto.randomBytes(32)
  â”‚    - é˜²æ­¢é‡æ”¾æ”»å‡»
  â”‚
  â”‚ 3. å‡†å¤‡ EIP-3009 æˆæƒæ•°æ®
  â”‚    authorization = {
  â”‚      from: "0xClientAddress",      // ä»˜æ¬¾äºº
  â”‚      to: "0xServerAddress",        // æ”¶æ¬¾äºº
  â”‚      value: "1000",                // é‡‘é¢
  â”‚      validAfter: "1740000000",     // æœ‰æ•ˆæœŸå¼€å§‹
  â”‚      validBefore: "1740000060",    // æœ‰æ•ˆæœŸç»“æŸï¼ˆ60ç§’åï¼‰
  â”‚      nonce: "0xrandom..."          // éšæœºæ•°
  â”‚    }
  â”‚
  â”‚ 4. ä½¿ç”¨ EIP-712 ç­¾å
  â”‚    - æ„é€  EIP-712 æ¶ˆæ¯
  â”‚    - ä½¿ç”¨ç§é’¥ç­¾å
  â”‚    - å¾—åˆ°ç­¾å signature
  â”‚
  â”‚ 5. æ„é€  PaymentPayload
  â”‚    payload = {
  â”‚      x402Version: 1,
  â”‚      scheme: "exact",
  â”‚      network: "hashkey-testnet",
  â”‚      payload: {
  â”‚        signature: "0x...",
  â”‚        authorization: { ... }
  â”‚      }
  â”‚    }
  â”‚
  â”‚ 6. Base64 ç¼–ç 
  â”‚    paymentHeader = base64(JSON.stringify(payload))


æ­¥éª¤ 3ï¸âƒ£: å®¢æˆ·ç«¯å‘é€å¸¦æ”¯ä»˜çš„è¯·æ±‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Client                    Resource Server
  â”‚
  â”‚  GET /api/weather
  â”‚  X-PAYMENT: eyJzY2hlbWUi...  (Base64 ç¼–ç çš„ PaymentPayload)
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚                          â”‚
  â”‚                          â”‚ 1. è§£ç  X-PAYMENT å¤´
  â”‚                          â”‚    payload = base64Decode(header)
  â”‚                          â”‚
  â”‚                          â”‚ 2. æå–æ”¯ä»˜ä¿¡æ¯
  â”‚                          â”‚    - æ£€æŸ¥ scheme, network
  â”‚                          â”‚    - æå– signature, authorization
  â”‚                          â”‚


æ­¥éª¤ 4ï¸âƒ£: æœåŠ¡å™¨éªŒè¯æ”¯ä»˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Resource Server           Facilitator           Blockchain
  â”‚                          â”‚                        â”‚
  â”‚  POST /verify            â”‚                        â”‚
  â”‚  {                       â”‚                        â”‚
  â”‚    paymentPayload,       â”‚                        â”‚
  â”‚    paymentRequirements   â”‚                        â”‚
  â”‚  }                       â”‚                        â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ éªŒè¯æ­¥éª¤ï¼š              â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 1. éªŒè¯ç­¾å            â”‚
  â”‚                          â”‚    âœ“ ä½¿ç”¨ EIP-712      â”‚
  â”‚                          â”‚    âœ“ æ¢å¤ç­¾åè€…åœ°å€     â”‚
  â”‚                          â”‚    âœ“ ç¡®è®¤æ˜¯ from åœ°å€   â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 2. æŸ¥è¯¢ä½™é¢            â”‚
  â”‚                          â”‚    USDC.balanceOf()    â”‚
  â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚    ä½™é¢: 10000         â”‚
  â”‚                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚    âœ“ ä½™é¢ >= 1000      â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 3. æ£€æŸ¥é‡‘é¢            â”‚
  â”‚                          â”‚    âœ“ value >= required â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 4. æ£€æŸ¥æ—¶é—´çª—å£         â”‚
  â”‚                          â”‚    âœ“ å½“å‰æ—¶é—´åœ¨æœ‰æ•ˆæœŸå†…  â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 5. æ£€æŸ¥æ”¶æ¬¾åœ°å€         â”‚
  â”‚                          â”‚    âœ“ to == payTo       â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 6. æ¨¡æ‹Ÿäº¤æ˜“            â”‚
  â”‚                          â”‚    simulate            â”‚
  â”‚                          â”‚    transferWithAuth()   â”‚
  â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚    æ¨¡æ‹ŸæˆåŠŸ             â”‚
  â”‚                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚                        â”‚
  â”‚  { isValid: true }       â”‚                        â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                          â”‚                        â”‚


æ­¥éª¤ 5ï¸âƒ£: æœåŠ¡å™¨å¤„ç†ä¸šåŠ¡é€»è¾‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Resource Server
  â”‚
  â”‚ éªŒè¯é€šè¿‡ï¼å¼€å§‹å¤„ç†è¯·æ±‚
  â”‚
  â”‚ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼š
  â”‚  - æŸ¥è¯¢å¤©æ°”æ•°æ®
  â”‚  - ç”ŸæˆæŠ¥å‘Š
  â”‚  - å‡†å¤‡å“åº”
  â”‚
  â”‚ weatherData = {
  â”‚   weather: "sunny",
  â”‚   temperature: 25
  â”‚ }


æ­¥éª¤ 6ï¸âƒ£: æœåŠ¡å™¨ç»“ç®—æ”¯ä»˜ï¼ˆä¸Šé“¾ï¼ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Resource Server           Facilitator           Blockchain (HashKey)
  â”‚                          â”‚                        â”‚
  â”‚  POST /settle            â”‚                        â”‚
  â”‚  {                       â”‚                        â”‚
  â”‚    paymentPayload,       â”‚                        â”‚
  â”‚    paymentRequirements   â”‚                        â”‚
  â”‚  }                       â”‚                        â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 1. å‡†å¤‡äº¤æ˜“            â”‚
  â”‚                          â”‚    contract = USDC     â”‚
  â”‚                          â”‚    method =            â”‚
  â”‚                          â”‚      transferWithAuth  â”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚ 2. å‘é€äº¤æ˜“            â”‚
  â”‚                          â”‚    (Facilitator ç­¾å)  â”‚
  â”‚                          â”‚    (Facilitator ä»˜ gas)â”‚
  â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚                        â”‚ é“¾ä¸Šæ‰§è¡Œï¼š
  â”‚                          â”‚                        â”‚ 
  â”‚                          â”‚                        â”‚ 1. éªŒè¯ç­¾å
  â”‚                          â”‚                        â”‚    âœ“ æ¢å¤ç­¾åè€…
  â”‚                          â”‚                        â”‚    âœ“ æ£€æŸ¥ nonce
  â”‚                          â”‚                        â”‚    âœ“ æ£€æŸ¥æ—¶é—´
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚                        â”‚ 2. è½¬è´¦
  â”‚                          â”‚                        â”‚    USDC: 
  â”‚                          â”‚                        â”‚    0xClient
  â”‚                          â”‚                        â”‚      â†’ 0xServer
  â”‚                          â”‚                        â”‚    é‡‘é¢: 1000
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚                        â”‚ 3. æ ‡è®° nonce
  â”‚                          â”‚                        â”‚    å·²ä½¿ç”¨ï¼Œé˜²é‡æ”¾
  â”‚                          â”‚                        â”‚
  â”‚                          â”‚    äº¤æ˜“æˆåŠŸ!            â”‚
  â”‚                          â”‚    txHash: 0x123...    â”‚
  â”‚                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚                        â”‚
  â”‚  {                       â”‚                        â”‚
  â”‚    success: true,        â”‚                        â”‚
  â”‚    transaction: "0x123", â”‚                        â”‚
  â”‚    network: "hashkey"    â”‚                        â”‚
  â”‚  }                       â”‚                        â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                          â”‚                        â”‚


æ­¥éª¤ 7ï¸âƒ£: æœåŠ¡å™¨è¿”å›å“åº”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Resource Server             Client
  â”‚                          â”‚
  â”‚  200 OK                  â”‚
  â”‚  X-PAYMENT-RESPONSE:     â”‚
  â”‚    eyJ0cmFuc2FjdGlvbiI6  â”‚
  â”‚                          â”‚
  â”‚  Body:                   â”‚
  â”‚  {                       â”‚
  â”‚    weather: "sunny",     â”‚
  â”‚    temperature: 25       â”‚
  â”‚  }                       â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                          â”‚
  â”‚                          â”‚ 1. æ”¶åˆ°æ•°æ®
  â”‚                          â”‚ 2. è§£ç  X-PAYMENT-RESPONSE
  â”‚                          â”‚ 3. è·å–äº¤æ˜“å“ˆå¸Œ
  â”‚                          â”‚ 4. å¯ä»¥åœ¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹
```

---

## EIP-3009 åŸç†

### ä¸ºä»€ä¹ˆéœ€è¦ EIP-3009ï¼Ÿ

**ä¼ ç»Ÿ ERC-20 è½¬è´¦çš„é—®é¢˜**ï¼š
```solidity
// ä¼ ç»Ÿæ–¹å¼éœ€è¦ä¸¤æ­¥ï¼š
1. approve(spender, amount)    // ç”¨æˆ·å‘äº¤æ˜“ï¼Œéœ€è¦ gas
2. transferFrom(from, to, amt) // ç¬¬ä¸‰æ–¹å‘äº¤æ˜“ï¼Œéœ€è¦ gas

// é—®é¢˜ï¼š
- ç”¨æˆ·å¿…é¡»æŒæœ‰ ETH æ”¯ä»˜ gas
- éœ€è¦ä¸¤ç¬”äº¤æ˜“
- ç”¨æˆ·ä½“éªŒå·®
```

**EIP-3009 çš„è§£å†³æ–¹æ¡ˆ**ï¼š
```solidity
// ä¸€æ­¥å®Œæˆï¼Œç”¨æˆ·ä¸éœ€è¦ gasï¼š
transferWithAuthorization(
  from,          // ä»˜æ¬¾äºº
  to,            // æ”¶æ¬¾äºº
  value,         // é‡‘é¢
  validAfter,    // æœ‰æ•ˆæœŸå¼€å§‹
  validBefore,   // æœ‰æ•ˆæœŸç»“æŸ
  nonce,         // éšæœºæ•°ï¼ˆé˜²é‡æ”¾ï¼‰
  v, r, s        // EIP-712 ç­¾å
)

// ä¼˜åŠ¿ï¼š
âœ“ ç”¨æˆ·åªéœ€ç­¾åï¼ˆä¸å‘äº¤æ˜“ï¼‰
âœ“ ç¬¬ä¸‰æ–¹ï¼ˆFacilitatorï¼‰ä»£ä¸ºæäº¤
âœ“ ç”¨æˆ·ä¸éœ€è¦ ETH/gas
âœ“ ä¸€ç¬”äº¤æ˜“å®Œæˆ
```

### EIP-3009 ç­¾åè¿‡ç¨‹

```javascript
// 1. å®šä¹‰ EIP-712 Domain
const domain = {
  name: "USDC",
  version: "2",
  chainId: 133,  // HashKey Testnet
  verifyingContract: "0xUSDCAddress"
};

// 2. å®šä¹‰æ¶ˆæ¯ç±»å‹
const types = {
  TransferWithAuthorization: [
    { name: "from", type: "address" },
    { name: "to", type: "address" },
    { name: "value", type: "uint256" },
    { name: "validAfter", type: "uint256" },
    { name: "validBefore", type: "uint256" },
    { name: "nonce", type: "bytes32" }
  ]
};

// 3. å‡†å¤‡æ¶ˆæ¯
const message = {
  from: "0xClientAddress",
  to: "0xServerAddress",
  value: "1000",
  validAfter: Math.floor(Date.now() / 1000),
  validBefore: Math.floor(Date.now() / 1000) + 60,
  nonce: crypto.randomBytes(32)
};

// 4. ç­¾å
const signature = await wallet._signTypedData(domain, types, message);
// å¾—åˆ°: "0x2d6a7588..."
```

### é“¾ä¸ŠéªŒè¯

```solidity
contract USDC {
    // å­˜å‚¨å·²ä½¿ç”¨çš„ nonce
    mapping(address => mapping(bytes32 => bool)) public authorizationState;
    
    function transferWithAuthorization(
        address from,
        address to,
        uint256 value,
        uint256 validAfter,
        uint256 validBefore,
        bytes32 nonce,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external {
        // 1. æ£€æŸ¥æ—¶é—´çª—å£
        require(block.timestamp > validAfter, "æœªåˆ°æœ‰æ•ˆæœŸ");
        require(block.timestamp < validBefore, "å·²è¿‡æœ‰æ•ˆæœŸ");
        
        // 2. æ£€æŸ¥ nonce æ˜¯å¦å·²ä½¿ç”¨
        require(!authorizationState[from][nonce], "æˆæƒå·²ä½¿ç”¨");
        
        // 3. æ¢å¤ç­¾åè€…åœ°å€
        bytes32 digest = keccak256(abi.encodePacked(
            "\x19\x01",
            DOMAIN_SEPARATOR,
            keccak256(abi.encode(
                TRANSFER_WITH_AUTHORIZATION_TYPEHASH,
                from, to, value, validAfter, validBefore, nonce
            ))
        ));
        address recoveredAddress = ecrecover(digest, v, r, s);
        
        // 4. éªŒè¯ç­¾åè€…æ˜¯ä»˜æ¬¾äºº
        require(recoveredAddress == from, "ç­¾åæ— æ•ˆ");
        
        // 5. æ ‡è®° nonce å·²ä½¿ç”¨
        authorizationState[from][nonce] = true;
        
        // 6. æ‰§è¡Œè½¬è´¦
        _transfer(from, to, value);
        
        emit AuthorizationUsed(from, nonce);
    }
}
```

---

## å®é™…ä»£ç æµç¨‹

### å®¢æˆ·ç«¯ä»£ç ï¼ˆTypeScriptï¼‰

```typescript
import axios from "axios";
import { withPaymentInterceptor, createSigner } from "x402-axios";

// 1. åˆ›å»ºç­¾åå™¨
const signer = await createSigner("hashkey-testnet", privateKey);

// 2. åˆ›å»ºå¸¦æ”¯ä»˜æ‹¦æˆªå™¨çš„ axios å®ä¾‹
const api = withPaymentInterceptor(
  axios.create({ baseURL: "http://localhost:4021" }),
  signer
);

// 3. å‘é€è¯·æ±‚ - æ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†æ”¯ä»˜ï¼
try {
  // ç¬¬ä¸€æ¬¡è¯·æ±‚ - ä¼šæ”¶åˆ° 402
  // æ‹¦æˆªå™¨è‡ªåŠ¨ï¼š
  //   - åˆ›å»ºç­¾å
  //   - é‡è¯•è¯·æ±‚å¹¶å¸¦ä¸Š X-PAYMENT å¤´
  const response = await api.get("/weather");
  
  console.log("å¤©æ°”æ•°æ®:", response.data);
  
  // 4. è·å–äº¤æ˜“ä¿¡æ¯
  const paymentResponse = decodeXPaymentResponse(
    response.headers["x-payment-response"]
  );
  console.log("äº¤æ˜“å“ˆå¸Œ:", paymentResponse.transaction);
  
} catch (error) {
  console.error("è¯·æ±‚å¤±è´¥:", error);
}
```

**æ‹¦æˆªå™¨å†…éƒ¨æµç¨‹**ï¼š

```typescript
// x402-axios å†…éƒ¨å®ç°
axios.interceptors.response.use(
  response => response,
  async error => {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ 402 å“åº”
    if (error.response?.status === 402) {
      const paymentRequirements = error.response.data.accepts[0];
      
      // åˆ›å»ºæ”¯ä»˜å¤´
      const paymentHeader = await createPaymentHeader(
        signer,
        1,  // x402Version
        paymentRequirements
      );
      
      // é‡è¯•è¯·æ±‚ï¼Œå¸¦ä¸Šæ”¯ä»˜å¤´
      return axios({
        ...error.config,
        headers: {
          ...error.config.headers,
          'X-PAYMENT': paymentHeader
        }
      });
    }
    throw error;
  }
);
```

### æœåŠ¡å™¨ä»£ç ï¼ˆExpressï¼‰

```typescript
import express from "express";
import { paymentMiddleware } from "x402-express";

const app = express();

// åº”ç”¨æ”¯ä»˜ä¸­é—´ä»¶
app.use(
  paymentMiddleware(
    "0xYourAddress",  // æ”¶æ¬¾åœ°å€
    {
      "GET /weather": {
        price: "$0.001",
        network: "hashkey-testnet",
      }
    },
    {
      url: "http://localhost:3000"  // Facilitator URL
    }
  )
);

// å®šä¹‰è·¯ç”±
app.get("/weather", (req, res) => {
  // ä¸­é—´ä»¶å·²ç»éªŒè¯å’Œç»“ç®—äº†æ”¯ä»˜
  // è¿™é‡Œç›´æ¥è¿”å›æ•°æ®
  res.json({
    weather: "sunny",
    temperature: 25
  });
});
```

**ä¸­é—´ä»¶å†…éƒ¨æµç¨‹**ï¼š

```typescript
// x402-express å†…éƒ¨å®ç°
async function paymentMiddleware(req, res, next) {
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜å¤´
  const paymentHeader = req.headers['x-payment'];
  
  if (!paymentHeader) {
    // è¿”å› 402 å’Œæ”¯ä»˜è¦æ±‚
    return res.status(402).json({
      x402Version: 1,
      accepts: [paymentRequirements],
      error: "Payment required"
    });
  }
  
  // 2. è§£ç æ”¯ä»˜å¤´
  const payload = JSON.parse(base64Decode(paymentHeader));
  
  // 3. éªŒè¯æ”¯ä»˜
  const facilitator = new FacilitatorClient({ url: facilitatorUrl });
  const verifyResult = await facilitator.verify(payload, paymentRequirements);
  
  if (!verifyResult.isValid) {
    return res.status(402).json({
      x402Version: 1,
      accepts: [paymentRequirements],
      error: verifyResult.invalidReason
    });
  }
  
  // 4. å¤„ç†è¯·æ±‚
  await next();
  
  // 5. ç»“ç®—æ”¯ä»˜
  const settleResult = await facilitator.settle(payload, paymentRequirements);
  
  // 6. æ·»åŠ æ”¯ä»˜å“åº”å¤´
  res.setHeader('X-PAYMENT-RESPONSE', 
    base64Encode(JSON.stringify(settleResult))
  );
}
```

---

## é—®é¢˜ä¸è§£ç­”

### Q1: å®¢æˆ·ç«¯ç­¾ååï¼Œé’±ä¼šç«‹å³è½¬èµ°å—ï¼Ÿ

**A**: ä¸ä¼šï¼å®¢æˆ·ç«¯åªæ˜¯**ç­¾åæˆæƒ**ï¼Œå¹¶æ²¡æœ‰å‘é€äº¤æ˜“ã€‚

æµç¨‹ï¼š
1. å®¢æˆ·ç«¯ç­¾å âœï¸ï¼ˆæœ¬åœ°ï¼Œä¸ä¸Šé“¾ï¼‰
2. å‘é€ç­¾åç»™æœåŠ¡å™¨ ğŸ“¤
3. æœåŠ¡å™¨éªŒè¯ç­¾å âœ…
4. æœåŠ¡å™¨æä¾›æœåŠ¡ ğŸ
5. **ç„¶å**æœåŠ¡å™¨é€šè¿‡ Facilitator æäº¤äº¤æ˜“ â›“ï¸
6. é“¾ä¸Šæ‰çœŸæ­£è½¬è´¦ ğŸ’¸

### Q2: Facilitator ä¼šä¸ä¼šæ‹¿èµ°æˆ‘çš„é’±ï¼Ÿ

**A**: ä¸ä¼šï¼å› ä¸ºï¼š

1. **ç­¾åé™åˆ¶äº†å‚æ•°**ï¼š
   ```javascript
   signature = sign({
     from: "0xClient",    // åªèƒ½ä»å®¢æˆ·ç«¯åœ°å€
     to: "0xServer",      // åªèƒ½è½¬åˆ°æœåŠ¡å™¨åœ°å€
     value: "1000",       // åªèƒ½è½¬è¿™ä¹ˆå¤š
     nonce: "0xrandom"    // è¿™ä¸ª nonce åªèƒ½ç”¨ä¸€æ¬¡
   })
   ```

2. **é“¾ä¸ŠéªŒè¯**ï¼š
   - æ™ºèƒ½åˆçº¦ä¼šéªŒè¯ç­¾å
   - ç¡®ä¿è½¬è´¦ç¬¦åˆç­¾åçš„å‚æ•°
   - Facilitator æ— æ³•ä¿®æ”¹ä»»ä½•å‚æ•°

3. **Facilitator åªæ˜¯ä»£å‘äº¤æ˜“**ï¼š
   - å°±åƒä½ å†™äº†ä¸€å¼ æ”¯ç¥¨
   - Facilitator åªæ˜¯å¸®ä½ æŠ•é€’
   - ä½†æ”¯ç¥¨é‡‘é¢ã€æ”¶æ¬¾äººéƒ½æ˜¯ä½ å†™æ­»çš„

### Q3: å¦‚æœ Facilitator ä¸ç»“ç®—æ€ä¹ˆåŠï¼Ÿ

**A**: ä½ æœ‰å‡ ä¸ªé€‰é¡¹ï¼š

1. **æœåŠ¡å™¨ä¸æä¾›æœåŠ¡**ï¼š
   - æœåŠ¡å™¨åœ¨ç»“ç®—æˆåŠŸåæ‰è¿”å›æ•°æ®
   - å¦‚æœ Facilitator ä¸ç»“ç®—ï¼Œå®¢æˆ·ç«¯æ”¶ä¸åˆ°æ•°æ®

2. **ç­¾åæœ‰æ—¶é—´é™åˆ¶**ï¼š
   ```javascript
   validBefore: now + 60 seconds
   ```
   - 60 ç§’åç­¾åå¤±æ•ˆ
   - å®¢æˆ·ç«¯çš„é’±ä¸ä¼šè¢«é”å®š

3. **å®¢æˆ·ç«¯å¯ä»¥é‡è¯•**ï¼š
   - ç”¨æ–°çš„ nonce é‡æ–°ç­¾å
   - å°è¯•å¦ä¸€ä¸ª Facilitator

### Q4: ä¸ºä»€ä¹ˆéœ€è¦ Facilitatorï¼ŸæœåŠ¡å™¨ç›´æ¥æäº¤äº¤æ˜“ä¸è¡Œå—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½† Facilitator æä¾›äº†æ›´å¥½çš„æ¶æ„ï¼š

**æ²¡æœ‰ Facilitator**ï¼š
```
æœåŠ¡å™¨éœ€è¦ï¼š
âŒ ç®¡ç†é’±åŒ…å’Œç§é’¥ï¼ˆå®‰å…¨é£é™©ï¼‰
âŒ æŒæœ‰ ETH/HSK æ”¯ä»˜ gas
âŒ è¿è¡ŒåŒºå—é“¾èŠ‚ç‚¹æˆ– RPC
âŒ å¤„ç†äº¤æ˜“å¤±è´¥ã€é‡è¯•
âŒ ç›‘æ§é“¾ä¸ŠçŠ¶æ€
```

**æœ‰ Facilitator**ï¼š
```
æœåŠ¡å™¨åªéœ€è¦ï¼š
âœ… è°ƒç”¨ HTTP API (verify/settle)
âœ… ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
âœ… ä¸éœ€è¦ç®¡ç†å¯†é’¥
âœ… ä¸éœ€è¦æŒæœ‰ gas
âœ… ä¸éœ€è¦æ‡‚åŒºå—é“¾
```

### Q5: æ•´ä¸ªæµç¨‹å“ªäº›æ­¥éª¤æ˜¯é“¾ä¸Šçš„ï¼Ÿ

**A**: åªæœ‰æœ€åä¸€æ­¥ï¼

```
âŒ å®¢æˆ·ç«¯ç­¾å          - æœ¬åœ°ï¼Œä¸ä¸Šé“¾
âŒ å‘é€ç­¾ååˆ°æœåŠ¡å™¨    - HTTPï¼Œä¸ä¸Šé“¾
âŒ æœåŠ¡å™¨éªŒè¯ç­¾å      - Facilitator é€šè¿‡ RPC æŸ¥è¯¢ï¼Œä½†ä¸å‘äº¤æ˜“
âŒ æœåŠ¡å™¨å¤„ç†ä¸šåŠ¡      - æœ¬åœ°ï¼Œä¸ä¸Šé“¾
âœ… Facilitator ç»“ç®—    - å‘é€äº¤æ˜“åˆ°é“¾ä¸Šï¼â›“ï¸
```

**é“¾ä¸Šåªæœ‰ä¸€ç¬”äº¤æ˜“**ï¼š
```solidity
USDC.transferWithAuthorization(
  from, to, value, validAfter, validBefore, nonce, v, r, s
)
```

### Q6: Gas è´¹ç”¨å¤šå°‘ï¼Ÿè°æ”¯ä»˜ï¼Ÿ

**A**: 

**Gas è´¹ç”¨**ï¼š
- ä¸€æ¬¡ `transferWithAuthorization` è°ƒç”¨
- å¤§çº¦ 80,000 - 120,000 gas
- åœ¨ HashKey Chain ä¸Šï¼ŒGas è´¹åº”è¯¥å¾ˆä¾¿å®œ

**è°æ”¯ä»˜**ï¼š
- **Facilitator** æ”¯ä»˜ï¼
- å®¢æˆ·ç«¯ä¸éœ€è¦æŒæœ‰ HSK
- æœåŠ¡å™¨ä¹Ÿä¸éœ€è¦æŒæœ‰ HSK
- è¿™å°±æ˜¯ "Gasless" çš„å«ä¹‰

**Facilitator æ€ä¹ˆç›ˆåˆ©**ï¼š
- å¯ä»¥æ”¶å–æœåŠ¡è´¹ï¼ˆä» USDC æ”¯ä»˜ä¸­æŠ½æˆï¼‰
- æˆ–è€…ä½œä¸ºåŸºç¡€è®¾æ–½å…è´¹æä¾›
- Coinbase çš„ Facilitator æ˜¯å…è´¹çš„ï¼ˆæµ‹è¯•ç½‘ï¼‰

---

## æ€»ç»“

### æ ¸å¿ƒæµç¨‹ï¼ˆ7 æ­¥ï¼‰

1. **å®¢æˆ·ç«¯è¯·æ±‚** â†’ æ”¶åˆ° 402 å’Œæ”¯ä»˜è¦æ±‚
2. **å®¢æˆ·ç«¯ç­¾å** â†’ åˆ›å»º EIP-712 ç­¾åï¼ˆæœ¬åœ°ï¼Œä¸ä¸Šé“¾ï¼‰
3. **å®¢æˆ·ç«¯é‡è¯•** â†’ å¸¦ X-PAYMENT å¤´é‡æ–°è¯·æ±‚
4. **æœåŠ¡å™¨éªŒè¯** â†’ é€šè¿‡ Facilitator éªŒè¯ç­¾åå’Œä½™é¢
5. **æœåŠ¡å™¨å¤„ç†** â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
6. **Facilitator ç»“ç®—** â†’ æäº¤äº¤æ˜“åˆ°åŒºå—é“¾ï¼ˆå”¯ä¸€çš„é“¾ä¸Šæ“ä½œï¼‰
7. **æœåŠ¡å™¨å“åº”** â†’ è¿”å›æ•°æ®å’Œäº¤æ˜“å“ˆå¸Œ

### å…³é”®ç‚¹

âœ… **åªæœ‰ä¸€ç¬”é“¾ä¸Šäº¤æ˜“** - é«˜æ•ˆ
âœ… **å®¢æˆ·ç«¯æ— éœ€ gas** - ç”¨æˆ·å‹å¥½  
âœ… **æœåŠ¡å™¨æ— éœ€é’±åŒ…** - æ¶æ„ç®€å•
âœ… **ç­¾åé™åˆ¶å‚æ•°** - å®‰å…¨å¯é 
âœ… **Facilitator å¯æ›¿æ¢** - å»ä¸­å¿ƒåŒ–

### ä¸‹ä¸€æ­¥

é˜…è¯» [EIP-3009 USDC éƒ¨ç½²æŒ‡å—](./DEPLOY_EIP3009_USDC.md) äº†è§£å¦‚ä½•åœ¨ HashKey Chain ä¸Šéƒ¨ç½²åˆçº¦ã€‚

---

**åˆ›å»ºæ—¶é—´**: 2025-10-24

