# x402 åè®®ä»£ç æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [æŠ€æœ¯æµç¨‹](#æŠ€æœ¯æµç¨‹)
5. [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
6. [å…³é”®å®ç°](#å…³é”®å®ç°)
7. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
8. [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## é¡¹ç›®æ¦‚è¿°

**x402** æ˜¯ä¸€ä¸ªå¼€æºçš„äº’è”ç½‘æ”¯ä»˜åè®®ï¼Œæ—¨åœ¨è®©å¼€å‘è€…åªç”¨ **1 è¡Œä»£ç ** å°±èƒ½æ¥å—æ•°å­—è´§å¸æ”¯ä»˜ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- âœ… **æ— æ‰‹ç»­è´¹** - ä¸æ”¶å–äº¤æ˜“æ‰‹ç»­è´¹
- âš¡ **2ç§’ç»“ç®—** - å¿«é€Ÿçš„åŒºå—é“¾äº¤æ˜“ç¡®è®¤
- ğŸ’° **$0.001 æœ€å°æ”¯ä»˜** - æ”¯æŒå¾®æ”¯ä»˜ï¼Œä¸åƒä¿¡ç”¨å¡æœ‰é«˜é¢æœ€ä½é™é¢
- ğŸ”“ **å¼€æ”¾æ ‡å‡†** - å®Œå…¨å¼€æºï¼Œä¸ä¾èµ–å•ä¸€æœåŠ¡å•†
- ğŸŒ **HTTP åŸç”Ÿ** - æ— ç¼é›†æˆåˆ°ç°æœ‰ HTTP æœåŠ¡ä¸­
- â›“ï¸ **é“¾å’Œä»£å¸æ— å…³** - æ”¯æŒå¤šæ¡åŒºå—é“¾å’Œå¤šç§ä»£å¸

### æ ¸å¿ƒç†å¿µ

> "äº’è”ç½‘ä¸Šçš„æ”¯ä»˜ä»æ ¹æœ¬ä¸Šæ˜¯æœ‰ç¼ºé™·çš„ã€‚ä¿¡ç”¨å¡æ‘©æ“¦åŠ›å¤§ã€æ¥å…¥éš¾ã€æœ€å°æ”¯ä»˜é¢å¤ªé«˜ï¼Œä¸ç¬¦åˆäº’è”ç½‘çš„ç¨‹åºåŒ–æœ¬è´¨ã€‚æ˜¯æ—¶å€™å»ºç«‹ä¸€ä¸ªå¼€æ”¾çš„ã€äº’è”ç½‘åŸç”Ÿçš„æ”¯ä»˜å½¢å¼äº†ã€‚"

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Resource Server  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Facilitator  â”‚
â”‚  (ä»˜æ¬¾æ–¹)    â”‚         â”‚   (èµ„æºæœåŠ¡å™¨)     â”‚         â”‚  (æ”¯ä»˜å¤„ç†å™¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                         â”‚                            â”‚
      â”‚  1. è¯·æ±‚èµ„æº             â”‚                            â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  2. è¿”å› 402 + æ”¯ä»˜è¦æ±‚   â”‚                            â”‚
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
      â”‚                         â”‚                            â”‚
      â”‚  3. å‘é€æ”¯ä»˜æˆæƒ          â”‚                            â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
      â”‚                         â”‚  4. éªŒè¯æ”¯ä»˜                 â”‚
      â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  5. è¿”å›éªŒè¯ç»“æœ             â”‚
      â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                         â”‚                            â”‚
      â”‚                         â”‚  6. ç»“ç®—æ”¯ä»˜åˆ°åŒºå—é“¾          â”‚
      â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                         â”‚                            â”‚
      â”‚  7. è¿”å›èµ„æº + äº¤æ˜“å“ˆå¸Œ    â”‚  8. è¿”å›äº¤æ˜“è¯¦æƒ…             â”‚
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
```

- **Client (å®¢æˆ·ç«¯)**: æƒ³è¦ä»˜è´¹è·å–èµ„æºçš„å®ä½“ï¼ˆäººç±»ç”¨æˆ·æˆ– AI Agentï¼‰
- **Resource Server (èµ„æºæœåŠ¡å™¨)**: æä¾› API æˆ–å…¶ä»–èµ„æºçš„ HTTP æœåŠ¡å™¨
- **Facilitator (ä¿ƒè¿›è€…/æ”¯ä»˜å¤„ç†å™¨)**: å¤„ç†æ”¯ä»˜éªŒè¯å’ŒåŒºå—é“¾äº¤æ˜“çš„æœåŠ¡å™¨

### 2. æ ¸å¿ƒ HTTP çŠ¶æ€ç å’Œå¤´éƒ¨

- **HTTP 402 Payment Required**: æŒ‡ç¤ºéœ€è¦ä»˜æ¬¾
- **X-PAYMENT** è¯·æ±‚å¤´: å®¢æˆ·ç«¯å‘é€æ”¯ä»˜æˆæƒ
- **X-PAYMENT-RESPONSE** å“åº”å¤´: æœåŠ¡å™¨è¿”å›äº¤æ˜“è¯¦æƒ…

### 3. ä¸‰å±‚æ¶æ„

x402 é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä½¿åè®®å…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Representation Layer (è¡¨ç¤ºå±‚)                      â”‚
â”‚  ä¼ è¾“æœºåˆ¶: HTTP, MCP, A2A                           â”‚
â”‚  å†³å®šå¦‚ä½•ä¼ è¾“å’Œä¿¡å·æ”¯ä»˜æ•°æ®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Types Layer (ç±»å‹å±‚)                               â”‚
â”‚  æ ¸å¿ƒæ•°æ®ç»“æ„: PaymentRequirements, PaymentPayload â”‚
â”‚  ç‹¬ç«‹äºä¼ è¾“å’Œæ”¯ä»˜æ–¹æ¡ˆ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logic Layer (é€»è¾‘å±‚)                               â”‚
â”‚  æ”¯ä»˜æ–¹æ¡ˆ: exact, deferred (è§„åˆ’ä¸­)                 â”‚
â”‚  ç½‘ç»œ: EVM, SVM, ç­‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¶æ„è®¾è®¡

### æ•°æ®ç±»å‹å®šä¹‰

#### 1. PaymentRequirements (æ”¯ä»˜è¦æ±‚)

æœåŠ¡å™¨å‘Šè¯‰å®¢æˆ·ç«¯å¦‚ä½•ä»˜æ¬¾ï¼š

```typescript
{
  scheme: "exact",                    // æ”¯ä»˜æ–¹æ¡ˆ
  network: "base-sepolia",            // åŒºå—é“¾ç½‘ç»œ
  maxAmountRequired: "10000",         // è¦æ±‚çš„é‡‘é¢ (åŸå­å•ä½)
  asset: "0x036CbD...",              // ä»£å¸åˆçº¦åœ°å€
  payTo: "0x209693...",              // æ”¶æ¬¾åœ°å€
  resource: "https://api.example.com/data",  // èµ„æº URL
  description: "Premium market data", // èµ„æºæè¿°
  mimeType: "application/json",      // å“åº”ç±»å‹
  maxTimeoutSeconds: 60,             // æœ€å¤§è¶…æ—¶æ—¶é—´
  extra: {                           // é¢å¤–ä¿¡æ¯ (æ–¹æ¡ˆç‰¹å®š)
    name: "USDC",
    version: "2"
  }
}
```

#### 2. PaymentPayload (æ”¯ä»˜è´Ÿè½½)

å®¢æˆ·ç«¯å‘é€çš„æ”¯ä»˜æˆæƒï¼š

```typescript
{
  x402Version: 1,
  scheme: "exact",
  network: "base-sepolia",
  payload: {
    signature: "0x2d6a75...",        // EIP-712 ç­¾å
    authorization: {
      from: "0x857b06...",           // ä»˜æ¬¾äººåœ°å€
      to: "0x209693...",             // æ”¶æ¬¾äººåœ°å€
      value: "10000",                // é‡‘é¢
      validAfter: "1740672089",      // æœ‰æ•ˆæœŸå¼€å§‹
      validBefore: "1740672154",     // æœ‰æ•ˆæœŸç»“æŸ
      nonce: "0xf37466..."          // é˜²é‡æ”¾æ”»å‡»çš„éšæœºæ•°
    }
  }
}
```

#### 3. SettlementResponse (ç»“ç®—å“åº”)

æœåŠ¡å™¨è¿”å›çš„äº¤æ˜“ä¿¡æ¯ï¼š

```typescript
{
  success: true,
  transaction: "0x1234567890abcdef...", // äº¤æ˜“å“ˆå¸Œ
  network: "base-sepolia",
  payer: "0x857b06..."
}
```

---

## æŠ€æœ¯æµç¨‹

### å®Œæ•´çš„æ”¯ä»˜æµç¨‹

```
æ­¥éª¤ 1-2: å‘ç°æ”¯ä»˜è¦æ±‚ (å¯é€‰ï¼Œå¦‚æœå®¢æˆ·ç«¯å·²çŸ¥å¯è·³è¿‡)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®¢æˆ·ç«¯                                     æœåŠ¡å™¨
  â”‚                                         â”‚
  â”‚  GET /api/data                          â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                         â”‚
  â”‚  402 Payment Required                   â”‚
  â”‚  {                                      â”‚
  â”‚    x402Version: 1,                      â”‚
  â”‚    accepts: [PaymentRequirements],      â”‚
  â”‚    error: "Payment required"            â”‚
  â”‚  }                                      â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                         â”‚

æ­¥éª¤ 3-7: æ”¯ä»˜å’Œèµ„æºè·å–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®¢æˆ·ç«¯                æœåŠ¡å™¨                ä¿ƒè¿›è€…
  â”‚                  â”‚                    â”‚
  â”‚ åˆ›å»ºç­¾åæˆæƒ       â”‚                    â”‚
  â”‚                  â”‚                    â”‚
  â”‚ GET /api/data    â”‚                    â”‚
  â”‚ X-PAYMENT: {...} â”‚                    â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
  â”‚                  â”‚ POST /verify       â”‚
  â”‚                  â”‚ {payload, reqs}    â”‚
  â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                  â”‚                    â”‚
  â”‚                  â”‚ {isValid: true}    â”‚
  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                  â”‚                    â”‚
  â”‚                  â”‚ å¤„ç†è¯·æ±‚            â”‚
  â”‚                  â”‚                    â”‚
  â”‚                  â”‚ POST /settle       â”‚
  â”‚                  â”‚ {payload, reqs}    â”‚
  â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                  â”‚                    â”‚ æäº¤åˆ°åŒºå—é“¾
  â”‚                  â”‚                    â”‚ ç­‰å¾…ç¡®è®¤
  â”‚                  â”‚ {success, txHash}  â”‚
  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                  â”‚                    â”‚
  â”‚ 200 OK           â”‚                    â”‚
  â”‚ X-PAYMENT-RESPONSE: {...}             â”‚
  â”‚ {èµ„æºæ•°æ®}        â”‚                    â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                  â”‚                    â”‚
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. EIP-3009: æˆæƒè½¬è´¦

x402 ä½¿ç”¨ EIP-3009 æ ‡å‡†ï¼Œè¿™æ˜¯ä¸€ç§**gasless**ï¼ˆæ— éœ€ gas è´¹ï¼‰çš„è½¬è´¦æ–¹å¼ï¼š

- ç”¨æˆ·ç­¾åæˆæƒï¼Œä½†ä¸å‘é€äº¤æ˜“
- æœåŠ¡å™¨ï¼ˆé€šè¿‡ Facilitatorï¼‰ä»£è¡¨ç”¨æˆ·æäº¤äº¤æ˜“
- ç”¨æˆ·ä¸éœ€è¦æŒæœ‰ ETH æ¥æ”¯ä»˜ gas
- ä½¿ç”¨ nonce é˜²æ­¢é‡æ”¾æ”»å‡»

```javascript
// EIP-3009 æˆæƒç»“æ„
TransferWithAuthorization {
  from: address,      // ä»˜æ¬¾äºº
  to: address,        // æ”¶æ¬¾äºº
  value: uint256,     // é‡‘é¢
  validAfter: uint256,  // æœ‰æ•ˆæœŸå¼€å§‹
  validBefore: uint256, // æœ‰æ•ˆæœŸç»“æŸ
  nonce: bytes32      // éšæœºæ•°
}
```

#### 2. å®‰å…¨æœºåˆ¶

**é˜²é‡æ”¾æ”»å‡»**:
- æ¯ä¸ªæˆæƒåŒ…å«å”¯ä¸€çš„ 32 å­—èŠ‚ nonce
- EIP-3009 åˆçº¦åœ¨åŒºå—é“¾å±‚é¢é˜²æ­¢ nonce é‡ç”¨
- æ—¶é—´çª—å£é™åˆ¶ï¼ˆvalidAfter/validBeforeï¼‰

**ä¿¡ä»»æœ€å°åŒ–**:
- Facilitator ä¸èƒ½ç§»åŠ¨èµ„é‡‘ï¼ˆåªèƒ½æŒ‰å®¢æˆ·æ„å›¾æ‰§è¡Œï¼‰
- å®¢æˆ·ç­¾åæ˜ç¡®æŒ‡å®šé‡‘é¢å’Œæ”¶æ¬¾äºº
- æœåŠ¡å™¨æ— æ³•ä¿®æ”¹æ”¯ä»˜å‚æ•°

---

## ä»£ç ç»“æ„

### TypeScript åŒ…ç»“æ„

```
typescript/packages/
â”œâ”€â”€ x402/                    # æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ client/              # å®¢æˆ·ç«¯é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ createPaymentHeader.ts    # åˆ›å»ºæ”¯ä»˜å¤´
â”‚   â”‚   â””â”€â”€ selectPaymentRequirements.ts  # é€‰æ‹©æ”¯ä»˜æ–¹æ¡ˆ
â”‚   â”œâ”€â”€ schemes/             # æ”¯ä»˜æ–¹æ¡ˆå®ç°
â”‚   â”‚   â””â”€â”€ exact/
â”‚   â”‚       â”œâ”€â”€ evm/         # EVM é“¾å®ç°
â”‚   â”‚       â””â”€â”€ svm/         # Solana å®ç°
â”‚   â”œâ”€â”€ facilitator/         # Facilitator å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ types/               # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ verify/              # éªŒè¯é€»è¾‘
â”‚
â”œâ”€â”€ x402-express/            # Express.js ä¸­é—´ä»¶
â”œâ”€â”€ x402-fastapi/            # FastAPI ä¸­é—´ä»¶ (Python)
â”œâ”€â”€ x402-axios/              # Axios æ‹¦æˆªå™¨
â”œâ”€â”€ x402-fetch/              # Fetch åŒ…è£…å™¨
â””â”€â”€ coinbase-x402/           # Coinbase çš„ Facilitator å®ç°
```

### Python åŒ…ç»“æ„

```
python/x402/src/x402/
â”œâ”€â”€ types.py                 # ç±»å‹å®šä¹‰
â”œâ”€â”€ facilitator.py           # Facilitator å®¢æˆ·ç«¯
â”œâ”€â”€ exact.py                 # Exact æ–¹æ¡ˆå®ç°
â”œâ”€â”€ clients/                 # HTTP å®¢æˆ·ç«¯é€‚é…å™¨
â”‚   â”œâ”€â”€ httpx.py
â”‚   â””â”€â”€ requests.py
â”œâ”€â”€ fastapi/                 # FastAPI ä¸­é—´ä»¶
â”‚   â””â”€â”€ middleware.py
â””â”€â”€ flask/                   # Flask ä¸­é—´ä»¶
    â””â”€â”€ middleware.py
```

---

## å…³é”®å®ç°

### 1. æœåŠ¡å™¨ç«¯ä¸­é—´ä»¶ (Python FastAPI)

```python
# python/x402/src/x402/fastapi/middleware.py

@validate_call
def require_payment(
    price: Price,                    # ä»·æ ¼ (å¦‚ "$0.01" æˆ– TokenAmount)
    pay_to_address: str,             # æ”¶æ¬¾åœ°å€
    path: str | list[str] = "*",     # è·¯å¾„åŒ¹é…
    network: str = "base-sepolia",   # åŒºå—é“¾ç½‘ç»œ
    facilitator_config: Optional[FacilitatorConfig] = None,
    # ... å…¶ä»–å‚æ•°
):
    """ç”Ÿæˆ FastAPI ä¸­é—´ä»¶æ¥ä¸ºç«¯ç‚¹è®¾ç½®æ”¯ä»˜é—¨æ§›"""
    
    # éªŒè¯ç½‘ç»œæ˜¯å¦æ”¯æŒ
    if network not in supported_networks:
        raise ValueError(f"Unsupported network: {network}")
    
    # å¤„ç†ä»·æ ¼å¹¶è½¬æ¢ä¸ºåŸå­å•ä½
    max_amount_required, asset_address, eip712_domain = \
        process_price_to_atomic_amount(price, network)
    
    # åˆ›å»º Facilitator å®¢æˆ·ç«¯
    facilitator = FacilitatorClient(facilitator_config)
    
    async def middleware(request: Request, call_next: Callable):
        # æ£€æŸ¥è·¯å¾„æ˜¯å¦åŒ¹é…
        if not path_is_match(path, request.url.path):
            return await call_next(request)
        
        # æ„é€ æ”¯ä»˜è¦æ±‚
        payment_requirements = [PaymentRequirements(...)]
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜å¤´
        payment_header = request.headers.get("X-PAYMENT", "")
        if payment_header == "":
            return x402_response("No X-PAYMENT header provided")
        
        # è§£ç æ”¯ä»˜å¤´
        payment = PaymentPayload(**json.loads(safe_base64_decode(payment_header)))
        
        # éªŒè¯æ”¯ä»˜
        verify_response = await facilitator.verify(payment, payment_requirements)
        if not verify_response.is_valid:
            return x402_response(f"Invalid payment: {verify_response.invalid_reason}")
        
        # å¤„ç†è¯·æ±‚
        response = await call_next(request)
        
        # å¦‚æœå“åº”æˆåŠŸï¼Œç»“ç®—æ”¯ä»˜
        if 200 <= response.status_code < 300:
            settle_response = await facilitator.settle(payment, payment_requirements)
            if settle_response.success:
                # æ·»åŠ æ”¯ä»˜å“åº”å¤´
                response.headers["X-PAYMENT-RESPONSE"] = base64.b64encode(
                    settle_response.model_dump_json(by_alias=True).encode("utf-8")
                ).decode("utf-8")
        
        return response
    
    return middleware
```

### 2. å®¢æˆ·ç«¯æ”¯ä»˜åˆ›å»º (TypeScript)

```typescript
// typescript/packages/x402/src/client/createPaymentHeader.ts

export async function createPaymentHeader(
  client: Signer | MultiNetworkSigner,
  x402Version: number,
  paymentRequirements: PaymentRequirements,
  config?: X402Config,
): Promise<string> {
  // æ ¹æ®æ”¯ä»˜æ–¹æ¡ˆè·¯ç”±
  if (paymentRequirements.scheme === "exact") {
    // æ ¹æ®ç½‘ç»œè·¯ç”± (EVM æˆ– SVM)
    if (SupportedEVMNetworks.includes(paymentRequirements.network)) {
      const evmClient = isMultiNetworkSigner(client) ? client.evm : client;
      return await createPaymentHeaderExactEVM(
        evmClient,
        x402Version,
        paymentRequirements,
      );
    }
    
    if (SupportedSVMNetworks.includes(paymentRequirements.network)) {
      const svmClient = isMultiNetworkSigner(client) ? client.svm : client;
      return await createPaymentHeaderExactSVM(
        svmClient,
        x402Version,
        paymentRequirements,
        config,
      );
    }
    
    throw new Error("Unsupported network");
  }
  
  throw new Error("Unsupported scheme");
}
```

### 3. Facilitator å®¢æˆ·ç«¯

```python
# python/x402/src/x402/facilitator.py

class FacilitatorClient:
    def __init__(self, config: Optional[FacilitatorConfig] = None):
        if config is None:
            config = {"url": "https://x402.org/facilitator"}
        self.config = config
    
    async def verify(
        self, 
        payment: PaymentPayload, 
        payment_requirements: PaymentRequirements
    ) -> VerifyResponse:
        """éªŒè¯æ”¯ä»˜æ˜¯å¦æœ‰æ•ˆ"""
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.config['url']}/verify",
                json={
                    "x402Version": payment.x402_version,
                    "paymentPayload": payment.model_dump(by_alias=True),
                    "paymentRequirements": payment_requirements.model_dump(by_alias=True),
                },
            )
            return VerifyResponse(**response.json())
    
    async def settle(
        self,
        payment: PaymentPayload,
        payment_requirements: PaymentRequirements
    ) -> SettleResponse:
        """ç»“ç®—æ”¯ä»˜åˆ°åŒºå—é“¾"""
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.config['url']}/settle",
                json={
                    "x402Version": payment.x402_version,
                    "paymentPayload": payment.model_dump(by_alias=True),
                    "paymentRequirements": payment_requirements.model_dump(by_alias=True),
                },
            )
            return SettleResponse(**response.json())
```

---

## ä½¿ç”¨ç¤ºä¾‹

### æœåŠ¡å™¨ç«¯ï¼šExpress.js

```typescript
import express from "express";
import { paymentMiddleware } from "x402-express";

const app = express();

// åªéœ€ä¸€è¡Œä»£ç æ·»åŠ æ”¯ä»˜é—¨æ§›ï¼
app.use(
  paymentMiddleware(
    "0xYourAddress",  // æ”¶æ¬¾åœ°å€
    {
      "GET /weather": {
        price: "$0.001",           // åªéœ€ 0.1 ç¾åˆ†
        network: "base-sepolia",
      },
      "/premium/*": {
        price: "$0.01",
        network: "base-sepolia",
      },
    },
  ),
);

// æ­£å¸¸å®šä¹‰ä½ çš„è·¯ç”±
app.get("/weather", (req, res) => {
  res.send({ weather: "sunny", temperature: 70 });
});

app.listen(4021);
```

### æœåŠ¡å™¨ç«¯ï¼šFastAPI (Python)

```python
from fastapi import FastAPI
from x402.fastapi.middleware import require_payment

app = FastAPI()

# ä¸ºç‰¹å®šè·¯ç”±åº”ç”¨æ”¯ä»˜ä¸­é—´ä»¶
app.middleware("http")(
    require_payment(
        path="/weather",
        price="$0.001",
        pay_to_address="0xYourAddress",
        network="base-sepolia",
    )
)

@app.get("/weather")
async def get_weather():
    return {"weather": "sunny", "temperature": 70}
```

### å®¢æˆ·ç«¯ï¼šAxios

```typescript
import axios from "axios";
import { withPaymentInterceptor, createSigner } from "x402-axios";

// åˆ›å»ºç­¾åå™¨
const signer = await createSigner("base-sepolia", privateKey);

// æ·»åŠ æ”¯ä»˜æ‹¦æˆªå™¨
const api = withPaymentInterceptor(
  axios.create({ baseURL: "https://api.example.com" }),
  signer,
);

// æ­£å¸¸å‘é€è¯·æ±‚ï¼Œæ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†æ”¯ä»˜ï¼
const response = await api.get("/weather");
console.log(response.data);

// è·å–æ”¯ä»˜ä¿¡æ¯
const paymentResponse = decodeXPaymentResponse(
  response.headers["x-payment-response"]
);
console.log(paymentResponse); // { success: true, transaction: "0x...", ... }
```

### å®¢æˆ·ç«¯ï¼šPython httpx

```python
from x402.clients.httpx import PaymentClient

# åˆ›å»ºæ”¯ä»˜å®¢æˆ·ç«¯
client = PaymentClient(
    private_key="0x...",
    network="base-sepolia",
)

# è‡ªåŠ¨å¤„ç†æ”¯ä»˜
response = await client.get("https://api.example.com/weather")
print(response.json())
```

---

## æ‰©å±•æ€§

### 1. æ”¯ä»˜æ–¹æ¡ˆ (Payment Schemes)

å½“å‰å®ç°çš„æ–¹æ¡ˆï¼š
- **exact**: ç²¾ç¡®é‡‘é¢è½¬è´¦ï¼ˆä½¿ç”¨ EIP-3009ï¼‰

è§„åˆ’ä¸­çš„æ–¹æ¡ˆï¼š
- **upto**: æŒ‰ä½¿ç”¨é‡ä»˜è´¹ï¼ˆé€‚åˆ LLM APIï¼‰
- **deferred**: å»¶è¿Ÿæ”¯ä»˜ï¼ˆå…ˆä½¿ç”¨åä»˜è´¹ï¼‰
- **commerce**: ç”µå•†æ–¹æ¡ˆï¼ˆæ”¯æŒé€€æ¬¾/æ‰˜ç®¡ï¼‰

### 2. åŒºå—é“¾ç½‘ç»œ

å½“å‰æ”¯æŒï¼š
- **EVM é“¾**: Base, Base Sepolia, Avalanche, Avalanche Fuji, IoTeX
- **Solana**: Solana Devnet, Mainnet

æ·»åŠ æ–°ç½‘ç»œçš„æ­¥éª¤ï¼š
1. åœ¨ `networks.ts` æ·»åŠ ç½‘ç»œé…ç½®
2. å®ç°ç‰¹å®šç½‘ç»œçš„å®¢æˆ·ç«¯é€»è¾‘
3. å®ç° Facilitator çš„éªŒè¯å’Œç»“ç®—é€»è¾‘

### 3. ä¼ è¾“å±‚ (Transport)

å½“å‰æ”¯æŒï¼š
- **HTTP**: REST API (æœ€å¸¸è§)
- **MCP**: Model Context Protocol (AI Agent)
- **A2A**: Agent-to-Agent (æ™ºèƒ½ä½“é—´é€šä¿¡)

å¯æ‰©å±•åˆ°ï¼š
- WebSocket
- gRPC
- è‡ªå®šä¹‰åè®®

### 4. æ¡†æ¶é›†æˆ

**å·²å®ç°**:
- Express.js, Hono, Next.js (TypeScript)
- FastAPI, Flask (Python)
- Gin (Go)

**ç¤¾åŒºè´¡çŒ®æœºä¼š**:
- Spring Boot (Java)
- Django (Python)
- Rails (Ruby)
- ç­‰ç­‰...

---

## å‘ç°å’Œå¸‚åœº (Bazaar)

x402 åŒ…å«ä¸€ä¸ª**å‘ç°æœºåˆ¶**ï¼Œå…è®¸å®¢æˆ·ç«¯æ‰¾åˆ°å¯ç”¨çš„ x402 èµ„æºï¼š

```typescript
// åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ x402 èµ„æº
GET /discovery/resources?type=http&limit=10

// å“åº”
{
  "x402Version": 1,
  "items": [
    {
      "resource": "https://api.example.com/premium-data",
      "type": "http",
      "accepts": [PaymentRequirements],
      "lastUpdated": 1703123456,
      "metadata": {
        "category": "finance",
        "provider": "Example Corp"
      }
    }
  ]
}
```

è¿™ä½¿å¾—å¯ä»¥åˆ›å»º **x402 å¸‚åœº** (Bazaar)ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- æŒ‰ç±»åˆ«æµè§ˆ API
- æ¯”è¾ƒä»·æ ¼å’ŒåŠŸèƒ½
- å‘ç°æ–°çš„ x402 æœåŠ¡

---

## æŠ€æœ¯ä¼˜åŠ¿

### 1. å¯¹å¼€å‘è€…å‹å¥½
- **1 è¡Œä»£ç **é›†æˆåˆ°æœåŠ¡å™¨
- **1 ä¸ªå‡½æ•°**é›†æˆåˆ°å®¢æˆ·ç«¯
- ä¸éœ€è¦æ·±å…¥ç†è§£åŒºå—é“¾ç»†èŠ‚

### 2. Gasless (æ—  Gas è´¹)
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½ä¸éœ€è¦æŒæœ‰ ETH
- Facilitator ä»£ä¸ºæ”¯ä»˜ gas
- ç”¨æˆ·ä½“éªŒæ›´å¥½

### 3. å¾®æ”¯ä»˜å‹å¥½
- æœ€ä½ $0.001
- é€‚åˆ AI Agent æŒ‰éœ€ä»˜è´¹
- é€‚åˆå†…å®¹åˆ›ä½œè€…

### 4. å®‰å…¨å¯é 
- EIP-3009 æ ‡å‡†ï¼Œç»è¿‡éªŒè¯
- é˜²é‡æ”¾æ”»å‡»
- æ—¶é—´çª—å£é™åˆ¶
- ä¿¡ä»»æœ€å°åŒ–è®¾è®¡

### 5. é«˜åº¦å¯æ‰©å±•
- æ¨¡å—åŒ–æ¶æ„
- æ”¯æŒå¤šé“¾
- æ”¯æŒå¤šç§ä¼ è¾“å±‚
- ç¤¾åŒºå¯è´¡çŒ®æ–°æ–¹æ¡ˆ

---

## è·¯çº¿å›¾äº®ç‚¹

### ç°åœ¨æ­£åœ¨åš
- âœ… x402 Bazaar å·²ä¸Šçº¿
- ğŸ”¨ æŒ‰ä½¿ç”¨é‡ä»˜è´¹æ–¹æ¡ˆ (Usage-based)
- ğŸ”¨ MCP æ”¯æŒ

### æ¥ä¸‹æ¥
- å¼€æº CDP Go Facilitator
- Bazaar æ”¯æŒå¤–éƒ¨ Facilitator
- Solana æ”¯æŒ
- A2A å’Œ MCP åœ¨ Bazaar ä¸­çš„æ”¯æŒ
- èº«ä»½è§£å†³æ–¹æ¡ˆé›†æˆ

### æœªæ¥
- ERC-8004 é›†æˆï¼ˆæ™ºèƒ½ä½“ä¿¡èª‰ï¼‰
- ç”µå•†æ–¹æ¡ˆï¼ˆé€€æ¬¾/æ‰˜ç®¡ï¼‰
- ä»»æ„ä»£å¸æ”¯æŒï¼ˆPermit/Permit2ï¼‰
- XMTP æ”¯æŒ
- Facilitator è·¯ç”±å™¨

---

## é€‚ç”¨åœºæ™¯

### 1. AI Agent é›†æˆ
AI æ™ºèƒ½ä½“å¯ä»¥è‡ªä¸»æ”¯ä»˜èµ„æºï¼š
- è‡ªåŠ¨æ”¯ä»˜ API è°ƒç”¨
- èµ„æºå‘ç°
- é¢„ç®—ç®¡ç†
- è·¨åè®®æ”¯ä»˜

### 2. å†…å®¹è´§å¸åŒ–
- æŒ‰æ–‡ç« ä»˜è´¹
- è®¢é˜…æ¨¡å¼
- è§†é¢‘/éŸ³é¢‘å†…å®¹
- æ•°æ®ä¸‹è½½

### 3. API è´§å¸åŒ–
- å¤©æ°”æ•°æ®
- é‡‘èæ•°æ®
- AI æ¨¡å‹æ¨ç†
- å›¾ç‰‡å¤„ç†

### 4. å¾®æœåŠ¡æ”¶è´¹
- RPC èŠ‚ç‚¹
- IPFS ç½‘å…³
- CDN æœåŠ¡
- è®¡ç®—èµ„æº

---

## æ€»ç»“

x402 æ˜¯ä¸€ä¸ªé©å‘½æ€§çš„äº’è”ç½‘æ”¯ä»˜åè®®ï¼Œå®ƒï¼š

1. **ç®€åŒ–é›†æˆ** - 1 è¡Œä»£ç å³å¯å¼€å§‹æ¥å—æ”¯ä»˜
2. **é™ä½é—¨æ§›** - æ”¯æŒå¾®æ”¯ä»˜ï¼Œæœ€ä½ $0.001
3. **æå‡ä½“éªŒ** - Gaslessï¼Œ2 ç§’ç»“ç®—
4. **ä¿è¯å®‰å…¨** - åŸºäºæˆç†Ÿçš„åŒºå—é“¾æ ‡å‡†
5. **é«˜åº¦å¼€æ”¾** - å®Œå…¨å¼€æºï¼Œç¤¾åŒºé©±åŠ¨

å®ƒä¸ºäº’è”ç½‘å¸¦æ¥äº†çœŸæ­£çš„ç¨‹åºåŒ–æ”¯ä»˜èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆï¼š
- AI Agent è‡ªä¸»äº¤æ˜“
- å†…å®¹åˆ›ä½œè€…è´§å¸åŒ–
- API æœåŠ¡å•†æ”¶è´¹
- å¾®æœåŠ¡æ¶æ„

è¿™æ˜¯ä¸€ä¸ªæ­£åœ¨å¿«é€Ÿå‘å±•çš„ç”Ÿæ€ç³»ç»Ÿï¼Œæ¬¢è¿ç¤¾åŒºè´¡çŒ®ï¼

---

## å‚è€ƒèµ„æº

- [å®˜æ–¹ç½‘ç«™](https://x402.org)
- [GitHub ä»“åº“](https://github.com/coinbase/x402)
- [è§„èŒƒæ–‡æ¡£](./specs/x402-specification.md)
- [è·¯çº¿å›¾](./ROADMAP.md)
- [è´¡çŒ®æŒ‡å—](./CONTRIBUTING.md)

---

**åˆ›å»ºæ—¶é—´**: 2025-10-24
**ç»´æŠ¤è€…**: x402 ç¤¾åŒº

